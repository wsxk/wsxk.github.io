---
layout: post
tags: [pwn]
title: "heap"
author: wsxk
date: 2025-2-15
comments: true
---

- [1. what is heap?](#1-what-is-heap)
  - [1.1 å¤æ—©çš„åŠ¨æ€åˆ†é…ï¼šmmap](#11-å¤æ—©çš„åŠ¨æ€åˆ†é…mmap)
  - [1.2 æ›´èªæ˜çš„åšæ³•: ç»´æŠ¤mmapå¾—åˆ°çš„å†…å­˜ï¼ŒæŒ‰éœ€å–ç”¨](#12-æ›´èªæ˜çš„åšæ³•-ç»´æŠ¤mmapå¾—åˆ°çš„å†…å­˜æŒ‰éœ€å–ç”¨)
  - [1.3 ptmalloc](#13-ptmalloc)
    - [1.3.1 ptmallocå·¥ä½œåŸç†](#131-ptmallocå·¥ä½œåŸç†)
  - [1.4 dangers of heap](#14-dangers-of-heap)
- [2. tcache](#2-tcache)
  - [2.1 tcache freeè¿‡ç¨‹(glibc2.31)](#21-tcache-freeè¿‡ç¨‹glibc231)
  - [2.2 tcache allocationè¿‡ç¨‹(glibc2.31)](#22-tcache-allocationè¿‡ç¨‹glibc231)
  - [2.3 tcache double free(glibc2.31)](#23-tcache-double-freeglibc231)
  - [2.4 tcache poisoning(glibc2.31)](#24-tcache-poisoningglibc231)
- [3. Chunks and Metadata](#3-chunks-and-metadata)
- [4. Metadata Corruption](#4-metadata-corruption)
- [5. Safe-Linking](#5-safe-linking)


# 1. what is heap?<br>
heapå…¶å®æŒ‡çš„æ˜¯ç¨‹åºå½“ä¸­åŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´<br>
å…¶ç”¨é€”åœ¨äºçµæ´»çš„æ§åˆ¶ç¨‹åºå½“ä¸­çš„å†…å­˜å¤§å°ã€‚å¸¸è§çš„ä½¿ç”¨ä¾‹å­æ˜¯ï¼šæ¸¸æˆä¸­NPCä»¬çš„å¯å˜é•¿åº¦åˆ—è¡¨<br>
## 1.1 å¤æ—©çš„åŠ¨æ€åˆ†é…ï¼šmmap<br>
mmapå…¶å®æ˜¯æœ€åˆçš„åŠ¨æ€åˆ†é…çš„é›å½¢ï¼Œå®ƒå…è®¸ç¨‹åºæ ¹æ®éœ€è¦ç”³è¯·/é‡Šæ”¾å†…å­˜ï¼Œä¸”å†…å­˜é•¿æœŸå­˜åœ¨ï¼Œä¸ä¼šéšå‡½æ•°ç»“æŸå°±é‡Šæ”¾ã€‚<br>
ä½†æ˜¯mmapçš„ç¼ºç‚¹ä¹Ÿæœ‰ï¼š**1ã€mmapç”³è¯·/é‡Šæ”¾çš„å†…å­˜å¤§å°å¿…é¡»æ˜¯4096å­—èŠ‚çš„æ•´æ•°å€ï¼Œä¸å¤Ÿçµæ´»ï¼›2ã€mmapç”³è¯·/é‡Šæ”¾å†…å­˜é€Ÿåº¦éå¸¸æ…¢ï¼Œå› ä¸ºæ¶‰åŠåˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œé™·å…¥å†…æ ¸**<br>
## 1.2 æ›´èªæ˜çš„åšæ³•: ç»´æŠ¤mmapå¾—åˆ°çš„å†…å­˜ï¼ŒæŒ‰éœ€å–ç”¨<br>
å¦‚æœæˆ‘ä»¬å…ˆç”¨mmapå¾—åˆ°ä¸€å—å†…å­˜ï¼Œå°†è¿™å—å†…å­˜ç®¡ç†èµ·æ¥ï¼ŒæŒ‰éœ€æ±‚åˆ†é…ï¼Œè¿™æ ·åœ¨éœ€æ±‚å°äºä¸€å®šå€¼çš„æ—¶å€™ï¼Œä¸éœ€è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ–¹ä¾¿å¿«æ·ï¼<br>
è¿™ä¸ªæ€è·¯ç›´æ¥å¯¼è‡´`Dynamic Allocators`è¯ç”Ÿ<br>
ä¸åŒç³»ç»Ÿä½¿ç”¨çš„`Dynamic Allocators`ç‰ˆæœ¬ä¹Ÿä¸ä¸€æ ·:<br>
```
General Purpose:
Doug Lea (pictured) releases dlmalloc into public domain in 1987.

Linux:
ptmalloc (Posix Thread aware fork of dlmalloc)

FreeBSD:
jemalloc (also used in Firefox, Android)

Windows:
Segment Heap, NT Heap

Kernel allocators:
kmalloc (Linux kernel memory allocator)
kalloc (iOS kernel memory allocator)
```

## 1.3 ptmalloc<br>
æœ¬ç¯‡æ–‡ç« ä¸­æè¿°å…¨éƒ½æ˜¯ptmallocç›¸å…³ç‰¹æ€§ï¼Œä¸åŒçš„åŠ¨æ€åˆ†é…å™¨æœºåˆ¶ä¸åŒï¼Œè¯·ä¸è¦æ··æ·†<br>
å¤§éƒ¨åˆ†åŠ¨æ€åˆ†é…å™¨(å½“ç„¶åŒ…æ‹¬ptmalloc)éƒ½æä¾›äº†å¦‚ä¸‹åŠŸèƒ½ï¼š<br>
```
1. malloc() - allocate some memory
2. free() - free a prior allocated chunk

And some auxiliary functions:
3. realloc() - change the size of an allocation
4. calloc() - allocate and zero-out memory
```

### 1.3.1 ptmallocå·¥ä½œåŸç†<br>
åœ¨æŸç§å†å²åŸå› ä¸‹ï¼Œptmallocå¹¶ä¸æ˜¯ç›´æ¥ç”¨mmapç”³è¯·å†…å­˜<br>

```
1. ptmalloc åˆå§‹åŒ–ç”³è¯·çš„å†…å­˜é€šå¸¸éƒ½åœ¨ç¨‹åºdata segment +éšæœºæŸä¸ªå€¼çš„ä½ç½®ã€‚

2. ptmalloc åˆå§‹åŒ–æ—¶ï¼Œä½¿ç”¨brkå’Œsbrkç³»ç»Ÿè°ƒç”¨æ¥ç”³è¯·ç©ºé—´
sbrk(NULL) ï¼š è¿”å›data segmentçš„æœ«å°¾
sbrk(delta) ï¼š ä»data segmentçš„æœ«å°¾æ‰©å¼ deltaå­—èŠ‚
brk(NULL): è¿”å›data segment + éšæœºæŸä¸ªå€¼çš„ä½ç½®
brk(addr)ï¼šå°†data segment + éšæœºæŸä¸ªå€¼ æ‰©å±•deltaå­—èŠ‚

3. ptmalloc å¯¹äºå°å†…å­˜ï¼Œé€šå¸¸éƒ½ç”¨ç¬¬2æ­¥ç”³è¯·æ¥çš„ç©ºé—´ï¼Œè¾ƒå¤§çš„å†…å­˜éƒ½é€šè¿‡mmapç”³è¯·ã€‚
```
## 1.4 dangers of heap<br>
å› ä¸ºå’±æ˜¯åšå®‰å…¨çš„ï¼Œå½“ç„¶è¦è€ƒè™‘çš„æ˜¯heapæœ‰ä»€ä¹ˆé£é™©å•¦ï¼Œè¯åˆè¯´å›æ¥ï¼Œ**heapçš„å®‰å…¨æ€§é€šå¸¸æ˜¯å’Œæ€§èƒ½å‘ˆç°ä¸€å®šç¨‹åº¦çš„å¯¹æŠ—å…³ç³»çš„**ï¼Œçœ‹ä¸‹å›¾:<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250223090802.png)
```
é¦–å…ˆåŠ¨æ€åˆ†é…å™¨å…¶å­˜åœ¨çš„å¿…è¦æ€§æ— éœ€å¤šè¨€ã€‚

1. åº”ç”¨å¼€å‘è€…å¸Œæœ›ä»–ä»¬çš„åº”ç”¨èƒ½æ›´æ–¹ä¾¿æ›´å¿«é€Ÿï¼Œä»–ä»¬å¸Œæœ›åŠ¨æ€åˆ†é…å™¨åˆ†é…å†…å­˜çš„é€Ÿåº¦ä¹Ÿæ›´å¿«ï¼
2. åˆ†é…å™¨çš„å¼€å‘è€…å›äº†å›åº”è¯‰æ±‚ï¼Œå¼€å§‹ä¼˜åŒ–åŠ¨æ€åˆ†é…å™¨çš„è¿è¡Œé€Ÿåº¦
3. å®‰å…¨ç ”ç©¶äººå‘˜å‘ç°æŸç§ä¼˜åŒ–ä¼šå¯¼è‡´ä¸¥é‡çš„å®‰å…¨éšæ‚£åï¼Œé€šçŸ¥åˆ†é…å™¨å¼€å‘è€…
4. åˆ†é…å™¨å¼€å‘è€…è®¤ä¸ºå®‰å…¨ä¸é‡è¦ï¼Œé€Ÿåº¦æ›´é‡è¦ï¼ˆå¾ˆåˆç†ï¼Œæ¯•ç«Ÿåˆ†é…å™¨å¥½åä¸å¦ï¼Œåˆ†é…å™¨å¼€å‘è€…çš„æ”¶ç›Š å–å†³äºä½¿ç”¨åˆ†é…å™¨çš„äººï¼‰
5. å®‰å…¨ç ”ç©¶äººå‘˜åˆ©ç”¨è¿™äº›é£é™©ï¼Œå¹¶é€šè¿‡åª’ä½“æ­éœ²é£é™©
6. åˆ†é…å™¨å¼€å‘è€…åœ¨å¤§ä¼—å‹åŠ›ä¸‹å†³å®šä¿®å¤è¿™ä¸ªæ¼æ´
7. é‡å›ç¬¬1æ­¥
```
é—­ç¯äº†ï¼ˆğŸ˜€<br>
è¯´å›æ­£é¢˜ï¼Œheapçš„ä¸»è¦é£é™©æœ‰ä»¥ä¸‹ä¸‰ç§:<br>
```
1. Forgetting to free memory. å¿˜è®°é‡Šæ”¾å†…å­˜
  leads to resource exhaustion å¯¼è‡´èµ„æºè€—å°½

2. Forgetting that we have freed memory. å¿˜è®°æˆ‘ä»¬å·²ç»é‡Šæ”¾äº†å†…å­˜
  using free memory æˆ‘ä»¬å¸¸è¯´çš„uaf
  freeing free memory æˆ‘ä»¬å¸¸è¯´çš„double free

3. Corrupting metadata used by the allocator to keep track of heap state. ç ´åç®¡ç†å †çš„å…ƒæ•°æ®ï¼ˆå¤§æ¦‚ç‡æ˜¯å †æº¢å‡ºï¼‰
  conceptually similar to corruption internal function state on the stack æ¦‚å¿µä¸Šå’Œç ´åæ ˆä¸Šçš„å‡½æ•°çŠ¶æ€ç±»ä¼¼ï¼Œ å³æˆ‘ä»¬å¸¸è¯´çš„å †é£æ°´

4. memory disclosure. å³ä¿¡æ¯æ³„éœ²
  æŸäº›chunkä¸­å¯èƒ½ä¿å­˜äº†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰ï¼Œå¦‚æœæœªåŠæ—¶æ¸…é›¶ï¼Œå¯èƒ½å¯¼è‡´å…³é”®ä¿¡æ¯æ³„éœ²,æˆ–è€…æ³„éœ²åœ°å€
```

# 2. tcache<br>
å…¶å®ä¹‹å‰çš„blogä¹Ÿè®²è¿‡ï¼Œå‚è€ƒ[glibc 2.31 å¸¸è§åˆ©ç”¨æ‰‹æ³•](https://wsxk.github.io/glic231/)ä¸­`tcacheåˆ©ç”¨ç¯‡`çš„ç« èŠ‚ã€‚<br>
`tcache`ï¼Œæ˜¯ptmallocåˆ†é…å™¨ä¸­çš„`Thread Local Caching`,å®ƒçš„è¯ç”Ÿæ˜¯ä¸ºäº†åŠ é€Ÿ å•çº¿ç¨‹ä¸­å°å†…å­˜çš„é‡å¤ç”³è¯·ã€‚<br>
`tcache bin`æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„å•å‘é“¾è¡¨ï¼Œä¸è¿‡å¤šå¤è¿°ã€‚<br>
## 2.1 tcache freeè¿‡ç¨‹(glibc2.31)<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250224213746.png)

## 2.2 tcache allocationè¿‡ç¨‹(glibc2.31)<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250224214133.png)
tcacheåœ¨mallocè¿‡ç¨‹ä¸­ä¸ä¼šæ£€æŸ¥ï¼Œè¿™ç»™äº†æˆ‘ä»¬å¯ä¹˜ä¹‹æœºã€‚<br>

## 2.3 tcache double free(glibc2.31)<br>
åœ¨tcache double freeçš„æˆç«‹æ¡ä»¶æ˜¯**é‡Šæ”¾å†…å­˜å—aåï¼Œä»ç„¶èƒ½å¤Ÿä¿®æ”¹a->key=0x1234ï¼Œç»•è¿‡double freeçš„æ ¡éªŒ**<br>
```c
int main(){
    unsigned long long * a;
    a = malloc(128);
    printf("Original malloc: %p\n",a);
    printf("Freeing: %p\n",a);
    free(a);

    printf("Corrupting key of: %p\n",a);
    a[1] = 0x1234;
    printf("Double-freeing: %p\n",a);
    free(a);

    printf("malloc 1: %p\n",malloc(128));
    printf("malloc 2: %p\n",malloc(128));
    printf("malloc 3: %p\n",malloc(128));
}
```
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250225221727.png)

## 2.4 tcache poisoning(glibc2.31)<br>
æ‰€è°“çš„tcache poisoningï¼Œå®é™…æ˜¯**é‡Šæ”¾å†…å­˜å—aåï¼Œä»ç„¶èƒ½å¤Ÿä¿®æ”¹a->next=xxxxï¼Œä½¿å…¶æ‰§è¡ŒæŸä¸ªæˆ‘ä»¬è®¾ç½®çš„å†…å­˜å—**<br>
```c
int main(){
    char stack_buffer[16];
    unsigned long long *a;
    unsigned long long *b;

    a = malloc(16);
    b = malloc(16);

    free(b);
    free(a);

    a[0] = stack_buffer;

    printf("Stack buffer: %p\n",stack_buffer);
    printf("First malloc: %p\n",malloc(16));
    printf("Second malloc: %p\n",malloc(16));
}
```
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250225222546.png)
# 3. Chunks and Metadata<br>
æ­£å¦‚tcacheä¸Šé¢æåˆ°çš„åˆ†é…å’Œé‡Šæ”¾è§„å¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ptmallocä½¿ç”¨äº†å¾ˆå¤š`metadata`ï¼ˆglobal metadataï¼štcache structureï¼Œè¿˜æœ‰æ¯ä¸ªchunkæœ¬èº«çš„metadataï¼‰æ¥è¿½è¸ªå®ƒåˆ†é…/é‡Šæ”¾çš„å†…å­˜ã€‚<br>
é€šä¿—æ„ä¹‰ä¸Šæ¥è¯´`chunk = metadata + æˆ‘ä»¬ç”¨æ¥å†™çš„å†…å­˜`,å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250226203922.png)
# 4. Metadata Corruption<br>

# 5. Safe-Linking<br>




<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C22S5YSYL7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-C22S5YSYL7');
</script>