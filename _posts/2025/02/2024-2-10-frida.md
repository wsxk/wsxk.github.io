---
layout: post
tags: [Android]
title: "frida hook revenge"
author: wsxk
date: 2025-2-10
comments: true
---

- [0. 写在前面](#0-写在前面)
- [1. 环境搭建](#1-环境搭建)
  - [1.1 夜神模拟器](#11-夜神模拟器)
  - [1.2 frida](#12-frida)
  - [1.3 frida试运行](#13-frida试运行)
    - [1.3.1 思路一: adb](#131-思路一-adb)
    - [1.3.2 思路二：直接拖拽frida-server到虚拟机](#132-思路二直接拖拽frida-server到虚拟机)
- [2. frida用法](#2-frida用法)
  - [2.1 使用python代码导入js脚本到目标进程](#21-使用python代码导入js脚本到目标进程)


# 0. 写在前面<br>
本篇是在[frida hook](https://wsxk.github.io/frida_hook/)的基础上继续往下开拓。<br>
上篇文章中只研究了`frida hook`的环境搭建和基本使用方法，存在许多缺陷：<br>
```
1. 只解决了基本问题，不能应对现在越来越复杂的ctf android题目。需要熟练掌握frida的其他用法
2. 对于frida的运行原理不了解，知其然不知其所以然
```
所以本篇主要还是聚焦`frida hook的实际功能和其基本原理`<br>


# 1. 环境搭建<br>
其实环境搭建可以参考[frida hook](https://wsxk.github.io/frida_hook/)中提到的真机环境和模拟器环境<br>
这里为了方便只介绍模拟器环境(其实是换电脑了需要新搭建一个环境)。<br>
**注意，大部分模拟器只能解决x86_64架构，若需在arm架构上解题/实践，最好还是来个真机**<br>

## 1.1 夜神模拟器<br>
虽然网上绝大多数人都在推荐雷电模拟器，但以我个人经验，夜神模拟器能cover住绝大多数场景，所以我没有换的打算。<br>
[夜神官网](https://www.yeshen.com/)<br>
下载好后，记得添加环境变量，因为夜神的目录中自带了`adb`<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250217211730.png)
添加环境变量后，记得重启terminal，以便环境变量刷新<br>

## 1.2 frida<br>
```
pip install frida
pip install frida-tools
```
注意你安装的frida版本，前往[https://github.com/frida/frida/releases](https://github.com/frida/frida/releases)选择相应版本的frida-server<br>
我安装时的版本为`frida 16.6.6`<br>
frida是在你的本地pc上运行的，frida-server是在你的安卓机器上运行的，两者会建立一条通道供你调试。<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250217225419.png)
根据你手机/虚拟机的架构，选择合适的frida-server。<br>

## 1.3 frida试运行<br>
如先前所说，需要把frida-server上传到真机/虚拟机上。<br>
我的frida版本是`16.6.6`因此我的frida-server版本也为`16.6.6`，虚拟机安卓架构为x86_64，所以上传的frida-server最终为`frida-server-16.6.6-android-x86_64`<br>
因为我是上传到虚拟机，这里提供两个思路<br>
### 1.3.1 思路一: adb<br>
```
adb devices # 查看设备名称
# -s 后跟着的是设备名称 push表示从本地上传文件到虚拟机，后续为路径
adb -s 127.0.0.1:62025 push .\frida-server-16.6.6-android-x86_64 /data/local/tmp/frida-server
adb -s 127.0.0.1:62025 shell # 进入虚拟机交互界面
cd /data/local/tmp/
chmod 777 frida-server 
./frida-server &
```
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250217230027.png)
如果运行正常，在本地启一个terminal，运行`frida-ps -U`能看到进程，说明成功安装。<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250217230449.png)

### 1.3.2 思路二：直接拖拽frida-server到虚拟机<br>
某些严格场景下，你可能无法adb push（会被警告，但是直接拖拽不会出现这个问题）<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-9-25/20250217230727.png)
接下来将`adb shell`进入后，将frida-server路径移动到`/data/local/tmp/`并赋予权限执行即可<br>

# 2. frida用法<br>
## 2.1 使用python代码导入js脚本到目标进程<br>
```python
import frida

device = frida.get_usb_device(timeout=10) # 获取设备，设置10s防止卡死
print(device) # Device(id="127.0.0.1:62025", name="SM-S9110", type='usb')
session = device.attach(3132) # 通过frida-ps -U 找到对应进程id，attach上去

# 打开js脚本并读取内容，在进程中创建这个脚本并加载执行
with open(r"C:\Users\wsxk\Desktop\CTF\Mobile\script.js",encoding='UTF-8') as f:
    script = session.create_script(f.read())
script.load()

# 脚本会持续运行等待输入
input()
```
读入的脚本当中，就有我们希望apk做的事情的代码了<br>
接下来我会介绍完成某个特定行为所需要写的js代码是哪些。<br>




<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C22S5YSYL7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-C22S5YSYL7');
</script>