---
layout: post
tags: [re]
title: "reverse engineering: ç»¼è¿°"
date: 2024-9-1
author: wsxk
comments: true
---

- [1. ä»€ä¹ˆæ˜¯é€†å‘å·¥ç¨‹](#1-ä»€ä¹ˆæ˜¯é€†å‘å·¥ç¨‹)
- [2. å‡½æ•°å’Œæ ˆå¸§](#2-å‡½æ•°å’Œæ ˆå¸§)
  - [2.1 ä»€ä¹ˆæ˜¯ç¨‹åº](#21-ä»€ä¹ˆæ˜¯ç¨‹åº)
  - [2.2 æ ˆå¸§](#22-æ ˆå¸§)
  - [2.3 æ•°æ®](#23-æ•°æ®)
- [3. é™æ€åˆ†æå·¥å…·](#3-é™æ€åˆ†æå·¥å…·)
- [4. åŠ¨æ€åˆ†æå·¥å…·](#4-åŠ¨æ€åˆ†æå·¥å…·)
- [5. é€†å‘å·¥ç¨‹çš„å®é™…åº”ç”¨](#5-é€†å‘å·¥ç¨‹çš„å®é™…åº”ç”¨)
  - [5.1 keygen](#51-keygen)
  - [5.2 modding](#52-modding)


## 1. ä»€ä¹ˆæ˜¯é€†å‘å·¥ç¨‹<br>
åœ¨è®²é€†å‘å·¥ç¨‹å‰ï¼Œå…ˆè¯´è¯´æ­£å‘å·¥ç¨‹ï¼Œ**æ­£å‘å·¥ç¨‹æŒ‡çš„æ˜¯ä½ ç¼–å†™ä¸€ä¸ªç¨‹åºçš„è¿‡ç¨‹**ï¼ŒåŒ…æ‹¬ç¡®å®šè¦å†™ä»€ä¹ˆç¨‹åºï¼Œå¼€å§‹å†™ç¨‹åºï¼Œç¼–è¯‘ç¨‹åºï¼Œæ‰§è¡Œç¨‹åº<br>
åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­**å­˜åœ¨ä¿¡æ¯æŸå¤±**<br>
![](https://raw.githubusercontent.com/wsxk/wsxk_pictures/main/2024-3-25/20240819191626.png)
```
åœ¨designå’Œcodeä¹‹é—´ï¼Œä½ æˆ–è®¸ä¼šå¿˜è®°æ˜¯è°å†™çš„ç¨‹åº

åœ¨compileå’Œassembleä¹‹é—´ï¼Œä¼šä¸¢å¤±ä»£ç æ³¨é‡Šã€å˜é‡åç§°ã€å‡½æ•°åç§°ã€ç»“æ„ä½“æ•°æ®ã€æœ‰æ—¶è¿˜ä¼šä¸¢å¤±è¿™ä¸ªç®—æ³•(optimization)
```
**æŠŠæ­£å‘å·¥ç¨‹ä¸­ä¸¢å¤±çš„ä¿¡æ¯ï¼Œé€šè¿‡äººçš„ä¸€äº›åŠªåŠ›å·¥ä½œï¼Œè¿˜åŸä¿¡æ¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åšé€†å‘å·¥ç¨‹**<br>
è¿™é¡¹æŠ€æœ¯çš„æ ¸å¿ƒæ˜¯:`how do we reverse the design from the binary(æˆ‘ä»¬å¦‚ä½•ä»äºŒè¿›åˆ¶é€†å‘å‡ºè®¾è®¡æ€æƒ³)`<br>

## 2. å‡½æ•°å’Œæ ˆå¸§<br>
### 2.1 ä»€ä¹ˆæ˜¯ç¨‹åº<br>
ç¨‹åºå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œç»“æ„:<br>

- 1.ä¸€ä¸ªç¨‹åº(program)ç”±å¾ˆå¤šä¸ªæ¨¡å—(module)ç»„æˆ
- 2.ä¸€ä¸ªæ¨¡å—(mudole)ç”±å¾ˆå¤šä¸ªå‡½æ•°(functionality)ç»„æˆ
- 3.ä¸€ä¸ªå‡½æ•°(functionality)åŒ…å«äº†å¾ˆå¤šå—(block)
- 4.å—ä¸­æœ‰å¾ˆå¤šæ¡æŒ‡ä»¤(instruction)
- 5.æŒ‡ä»¤(instruction)ä¸»è¦ç”¨æ¥æ“ä½œå˜é‡(variables)å’Œæ•°æ®ç»“æ„(data structures)


åœ¨é€†å‘è¿‡ç¨‹ä¸­ï¼Œ`module`é€šå¸¸æ˜¯ä»¥`lib`çš„å½¢å¼å‘ˆç°ï¼Œå³åŠ¨æ€åº“å’Œé™æ€åº“ï¼Œå¼€å‘äººå‘˜æå¤§ç¨‹åº¦çš„ä¾é åº“å‡½æ•°ã€‚<br>
åœ¨é€†å‘æ—¶éœ€è¦å…³æ³¨**åº“çš„ç²¾ç»†æ‰‹å†Œï¼Œåœ¨é€†å‘æ—¶æŠŠåº“å‡½æ•°æ’é™¤åœ¨å¤–ï¼Œä¸“å¿ƒé€†å‘ä¸»è¦é€»è¾‘**<br><br><br>
å‡½æ•°å°±æ˜¯æŒ‡å®ç°å¥½çš„æŸç§åŠŸèƒ½ï¼Œé€šå¸¸æ¯ä¸ªå‡½æ•°çš„å®ç°éƒ½æœ‰æ˜ç¡®çš„ç›®çš„<br>
ä¾‹å¦‚è·å–ä¸€äº›æ•°æ®ï¼Œåˆ†å‘åŠŸèƒ½,etc.<br>
**ä¸€å¼€å§‹ï¼Œå‡½æ•°å¯ä»¥å•ç‹¬é€†å‘ï¼Œä¹‹åå°±å¯ä»¥äº†è§£å‡½æ•°ä»¬æ˜¯å¦‚ä½•è¢«ç»„åˆçš„**<br><br><br>
å‡½æ•°å¯ä»¥é€šè¿‡`graph(å›¾)`è¡¨ç¤ºï¼Œ`graph`ç”±å¾ˆå¤š`block(å—)`å’Œå¾ˆå¤šæ¡`edge(è¾¹)`æ„æˆ<br>
`block`å°±æ˜¯è®¡ç®—æœºæ‰§è¡Œçš„æŒ‡ä»¤(`instruction`)çš„é›†åˆï¼Œblockç”±`edge`è¿æ¥<br>

### 2.2 æ ˆå¸§<br>
æ¯ä¸ª`function`åºè¨€å’Œç»“è¯­çš„æŒ‡ä»¤éƒ½å¾ˆç±»ä¼¼ï¼š<br>
**Set up the stack frame.**<br>
**Tear down the stack frame**<br>
å¼€è¾Ÿæ ˆå¸§çš„ä¸»è¦ç›®çš„æ˜¯åœ¨æ ˆä¸­ç»™æ¯ä¸ªå‡½æ•°å¼€è¾Ÿä¸€æ®µç©ºé—´ç”¨äºå­˜æ”¾å±€éƒ¨å˜é‡ï¼ï¼ˆä½†ä¸æ˜¯å¿…é¡»çš„ï¼‰<br>
åœ¨ä¸€ä¸ª`elf`æ–‡ä»¶ä¸­ï¼Œæœ‰3ä¸ªæ®µè¢«ç”¨æ¥å­˜æ”¾æ•°æ®:<br>
```
.data: 
used for pre-initialized global writable data (such as global arrays with initial values)

.rodata: 
used for global read-only data (such as string constants)

.bss: 
used for uninitialized global writable data (such as global arrays without initial values)
```
ä½†æ˜¯è¿™3ä¸ªæ®µéƒ½è¢«ç”¨æ¥å­˜æ”¾å…¨å±€å˜é‡ï¼Œå¯¹äºå±€éƒ¨å˜é‡ï¼Œä¸€èˆ¬éƒ½æ”¾åœ¨æ ˆä¸­ï¼Œ**æ ˆæ˜¯ä¸€æ®µç”¨æ¥å­˜å‚¨å±€éƒ¨å˜é‡å’Œå‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡çš„ç©ºé—´ï¼Œé‡‡ç”¨åè¿›å…ˆå‡ºçš„æ–¹å¼(å³åå‘å¢é•¿)**<br>
é¡ºé“ä¸€æï¼Œç¨‹åºçš„ç¯å¢ƒå˜é‡ä¹Ÿæ˜¯å­˜æ”¾åœ¨æ ˆä¸­çš„<br>

**gccç¼–è¯‘æ—¶ï¼Œå¯ä»¥é€šè¿‡-fomit-frame-pointeré€‰é¡¹å–æ¶ˆæ ˆå¸§çš„ä½¿ç”¨**<br>

### 2.3 æ•°æ®<br>
æ€»ç»“ä¸€ä¸‹ï¼Œä¸€ä¸ªç¨‹åº(program)ä¸­ç”¨æ¥å­˜æ”¾æ•°æ®çš„ç©ºé—´æœ‰5å¤„:<br>
```
.data: 
used for pre-initialized global writable data (such as global arrays with initial values)

.rodata: 
used for global read-only data (such as string constants)

.bss: 
used for uninitialized global writable data (such as global arrays without initial values)

stack: 
used for statically-allocated local variables

heap: used for dynamically-allocated (malloc()ed) variables. 
```

## 3. é™æ€åˆ†æå·¥å…·<br>
`Static (as opposed to dynamic) reverse engineering: analyzing a program at rest`<br>
é™æ€åˆ†æå·¥å…·é‡Œæœ‰å¾ˆå¤šå¥½ç”¨ä¸œè¥¿:<br>
```
kaitai struct (https://ide.kaitai.io/): file format parser and explorer

nm: lists symbols used/provided by ELF files

strings: dumps ASCII (and other format) strings found in a file

objdump: simple disassembler

checksec (https://github.com/slimm609/checksec.sh): analyzes security features used by an executable
```
å½“ç„¶ï¼Œä¸Šè¿°åªèƒ½çœ‹åˆ°äºŒè¿›åˆ¶æ–‡ä»¶çš„æŸäº›å†…å®¹ï¼Œè¦æƒ³åˆ†æç¨‹åºé€»è¾‘ï¼Œè¿˜éœ€è¦åæ±‡ç¼–å™¨ï¼<br>
```
Commercial:
IDA Pro: the "gold standard" of disassemblers (https://www.hex-rays.com/products/ida/)
Binary Ninja: IDA's main commercial competitor (https://binary.ninja/)

Free:
Binary Ninja Cloud: a version of Binary Ninja that runs in your browser! (https://cloud.binary.ninja/) 

Open source:
angr management: an academic binary analysis framework! (https://github.com/angr/angr-management/releases) 
ghidra: a reversing tool created by the National Security Agency (https://ghidra-sre.org/) 
cutter: a reversing tool created by the radare2 open source project (https://cutter.re/) 
```

## 4. åŠ¨æ€åˆ†æå·¥å…·<br>
`Dynamic (as opposed to static) reverse engineering: analyzing a program at runtime.`<br>
åŠ¨æ€åˆ†æå·¥å…·å°±æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶åˆ†æå®ƒçš„é€»è¾‘ã€‚<br>
å¸¸è§çš„åŠ¨æ€åˆ†æå·¥å…·æœ‰<br>

```
ltrace :traces library calls
strace :traces system calls

Running the program with multiple different inputs might get you farther.
ltrace the program with input A
ltrace the program again with input B
see if you can reverse the algorithm from looking at input and output
still does not scale to complex algorithms
```
å‰é¢ä¸¤ä¸ªç”¨æ¥åˆ†æç®€å•çš„ç®—æ³•è¿˜æ˜¯æ²¡é—®é¢˜çš„ï¼Œå¤æ‚çš„å°±éš¾äº†ï¼Œè¿™æ—¶å€™å°±è¦è¯·å‡ºæˆ‘ä»¬çš„é«˜æ‰‹ï¼Œgdbï¼<br>

```
gdb: è°ƒè¯•å·¥å…·ï¼
```

å¦å¤–è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µå«åš`Timeless Debugging`<br>

```
Timeless debugging frees you from having to think of breakpoints ahead of time.

1. record execution
2. rewind execution
3. replay execution
```
ç›¸å…³å·¥å…·å¦‚ä¸‹:<br>
1. gdb has built-in record-replay functionality 
å…¶ç½‘å€ä¸º[https://sourceware.org/gdb/current/onlinedocs/gdb/Process-Record-and-Replay.html](https://sourceware.org/gdb/current/onlinedocs/gdb/Process-Record-and-Replay.html)
2. rr is a highly-performant record-replay engine 
[https://github.com/mozilla/rr](https://github.com/mozilla/rr) <br>
3. qira is a timeless debugger made for reverse engineering 
[https://qira.me/](https://qira.me/)


## 5. é€†å‘å·¥ç¨‹çš„å®é™…åº”ç”¨<br>
é€†å‘å·¥ç¨‹åœ¨ç°å®ä¸­æ¯”è¾ƒå¤šçš„åº”ç”¨æœ‰ä¸¤ä¸ªæ–¹é¢ï¼š**keygenå’Œmodding**<br>
### 5.1 keygen<br>
1. ä¸Šå¤æ—¶æœŸï¼Œæ‰€æœ‰çš„åº”ç”¨éƒ½å¿…é¡»èƒ½ä¸é€šè¿‡äº’è”ç½‘è¿›è¡Œå®‰è£…ï¼Œè¿™å°±è¡¨æ˜**æ‰€æœ‰è¿è¡Œç¨‹åºæ‰€éœ€è¦çš„ç»„ä»¶éƒ½è¢«å®‰è£…åœ¨æœ¬åœ°**<br>
è½¯ä»¶å¼€å‘å•†ä¸ºäº†ä¿è¯äº¤è¿‡é’±çš„ç”¨æˆ·æ‰èƒ½ä½¿ç”¨å®ƒä»¬çš„è½¯ä»¶ï¼Œé€šå¸¸ç»„ä»¶é‡Œéƒ½æœ‰ä¸€ä¸ªå«åš`licence checker`çš„ä¸œè¥¿ç”¨æ¥æ ¡éªŒç”¨æˆ·æ˜¯å¦äº¤è¿‡é’±<br>
ä½†æ˜¯ç”±äº`licence checker`çš„é€»è¾‘éƒ½åœ¨æœ¬åœ°ï¼Œæ‰€ä»¥èƒ½å¤Ÿé€šè¿‡é€†å‘å…¶é€»è¾‘è¿˜åŸæ ¡éªŒé€»è¾‘ï¼Œä»è€Œç ´è§£è½¯ä»¶ï¼Œå¯¼è‡´ä¸äº¤é’±ä¹Ÿèƒ½ç”¨ï¼<br><br>
2. è¿›å…¥çŸ³å™¨æ—¶ä»£ï¼Œè‡ªä»æœ‰äº†**å“ˆå¸Œç®—æ³•ä¹‹åï¼ŒLicence checkerä¸­é€šå¸¸æ¯”å¯¹çš„éƒ½æ˜¯å“ˆå¸Œå€¼ï¼Œä½†æ˜¯å“ˆå¸Œæ˜¯ä¸å¯é€†çš„**ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ**ä¿®æ”¹äºŒè¿›åˆ¶ç¨‹åºå˜æˆäº†å¥½çš„é€‰æ‹©ï¼Œç›´æ¥patchå“ˆå¸Œæ ¡éªŒé€»è¾‘ï¼Œè®©éªŒè¯é€šè¿‡ï¼Œè¿˜ä¸ç”¨è¿˜åŸæ•´ä¸ªlicence checkerçš„é€»è¾‘ï¼Œèµ¢ï¼**<br><br>
3. è¿›å…¥é’é“œæ—¶ä»£ï¼Œä¸ºäº†æŠµæŠ—äºŒè¿›åˆ¶patchï¼Œå‡ºç°äº†ä»£ç æ··æ·†`obfuscated code`ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯**è®©ä½ çœ‹ä¸æ‡‚ä»£ç ï¼Œä»¥è‡³äºä¸çŸ¥é“patchå“ªé‡Œ**,ç»å…¸çš„æ··æ·†æ–¹å¼å°±æ˜¯`VM(virtual machine)`äº†.è™šæ‹Ÿæœºæ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯æ¨¡æ‹Ÿcpuçš„æŒ‡ä»¤æ‰§è¡Œæ­¥éª¤ï¼Œè¦æƒ³ç ´è¯‘éœ€è¦èŠ±å¿ƒæ€çœ‹æ‡‚å…¶å«ä¹‰,è¦æƒ³é€†å¥½VMï¼Œåªèƒ½é è€å¿ƒä¸æ–­ç»ƒä¹ äº†<br><br>
4. ç°ä»£ï¼Œè½¯ä»¶å¼€å‘å•†é€šå¸¸é€šè¿‡äº’è”ç½‘æ¥è¿›è¡Œæ ¡éªŒï¼ˆå³`licence checker`çš„é€»è¾‘åœ¨æœåŠ¡å™¨ï¼Œæ­£å¸¸æƒ…å†µæ— æ³•è¿˜åŸå…¶é€»è¾‘ï¼‰<br>
ç°åœ¨çš„è§£å†³åŠæ³•å¦‚ä¸‹:<br>

```
1. æ‰“ç©¿æœåŠ¡å™¨
2. patchæœ¬åœ°ç¨‹åºï¼Œç§»é™¤æ‰€æœ‰çš„checké€»è¾‘å¹¶ä¿è¯ç¨‹åºæ­£å¸¸è¿è¡Œ
3. èŠ±é’±
```

å¯¹äºæ–¹æ³•äºŒè€Œè¨€ï¼Œè½¯ä»¶å¼€å‘å•†ä¸ºäº†æŠµæŠ—ï¼Œç ”ç©¶äº†å¾ˆå¤šä¿æŠ¤æœºåˆ¶:<br>
```
1. Anti-debugging: 
techniques to fight dynamic analysis

2. VMing: 
wrapping the DRM(digital rights management) code in a heavily obfuscated, protected emulator for a custom architecture, with the DRM logic inside that architecture.

3. Trusted Execution Environments: 
moving the DRM outside of the CPU into protected hardware.
```
è¿™äº›ä¿æŠ¤æªæ–½çœŸçš„å¸¦æ¥äº†å¾ˆå¤§çš„é€†å‘éš¾åº¦ï¼<br>

### 5.2 modding<br>
ç©è¿‡steamä¸Šçš„æ¸¸æˆçš„äººéƒ½çŸ¥é“ï¼Œæ¸¸æˆæœ‰å¾ˆå¤šmodå¯ä»¥ç”¨ï¼Œè¿™ä¹Ÿæ˜¯é€†å‘å·¥ç¨‹çš„åŠŸåŠ³ã€‚<br>
æœ€å¼€å§‹å¤§å®¶éƒ½é€šè¿‡`ce engine`æ¥æ”¹æ¸¸æˆé‡Œçš„æ•°æ®ï¼ˆæ¯”å¦‚ç­‰çº§ï¼Œæ”»å‡»åŠ›,etcï¼‰ï¼Œæ¥å¢å¼ºå®åŠ›ã€‚<br>
åæ¥æ¸¸æˆäº§å•†æœ‰æ„è¯†çš„ä¿æŠ¤äº†è¿™äº›å…³é”®æ•°æ®ï¼Œå¤§å®¶å°±å¼€å§‹æ‰“modï¼Œå³ä¿®æ”¹/æ·»åŠ æ¸¸æˆçš„ä»£ç ï¼æ›´æœ‰ç”šè€…ï¼Œæœ‰äººåœ¨ç½‘ç»œæ¸¸æˆäº†ä¹Ÿè¿›è¡Œä½œå¼Šï¼<br>
è¿™é‡Œå¯èƒ½æœ‰äººå¥½å¥‡ï¼Œå¯¹æŠ—`keygen`çš„æ–¹æ³•ä¸èƒ½åº”ç”¨åœ¨æ¸¸æˆé‡Œå—ï¼Ÿ<br>
**ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä»£ä»·æ˜¯æƒ¨çƒˆçš„ï¼šé‚£äº›æ–¹æ³•ä¼šå¯¼è‡´ç¨‹åºçš„æ€§èƒ½å¼€é”€æ˜¾è‘—æé«˜(å¯èƒ½æ˜¯åŸæœ¬åº”ç”¨çš„å¥½å‡ å€)ï¼Œå¯¹äºæ™®é€šåº”ç”¨å€’ä¹Ÿç½¢äº†ï¼Œå¯¹äºæ¸¸æˆè€Œè¨€ï¼Œå°±æ˜¯æ˜æ˜¾æé«˜æ¸¸æˆå»¶è¿Ÿï¼Œé€ æˆæ¸¸æˆå¡é¡¿ï¼**<br>
è€Œä¸”ç°åœ¨å¤§å‹æ¸¸æˆå¾€å¾€æœ¬æ¥æ‰€éœ€èµ„æºå°±å¾ˆå¤šï¼Œå†åŠ ä¸ªå‡ å€è¿˜è®©ä¸è®©äººç©äº†ğŸ˜€æ‰€ä»¥æ¸¸æˆçš„ä¿æŠ¤å¾€å¾€ä¼šæ¯”è¾ƒå¼±ï¼Œ**å¦‚ä½•ç”¨è¾ƒå°‘çš„èµ„æºæ¥æœ‰æ•ˆç‡å¾—æé«˜æ¸¸æˆå®‰å…¨æ€§å°±æ˜¯å½“ä¸‹çš„è‰ºæœ¯**<br>
æƒ³è¦åšå¥½é€†å‘ä¸å®¹æ˜“ï¼Œéœ€è¦ç¨³æ‰ç¨³æ‰“çš„å®æˆ˜ï¼ï¼ˆå€’ä¸å¦‚è¯´ï¼Œåšå®‰å…¨è¿˜æ˜¯å®æˆ˜æ›´é‡è¦ï¼‰<br>